<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>현재 위치와 동물병원</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script> <!-- 좌표 변환 라이브러리 -->
    <style>
        #map {
            width: 100%;
            height: 500px;
        }
        #search-container {
            margin-top: 20px;
        }
        #search-results {
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div th:replace="~{common/header :: header}"></div>

<h1>내 현재 위치와 주변 동물병원</h1>
<!-- 검색창 -->
<div id="search-container">
    <input type="text" id="search-input" placeholder="병원 이름을 입력하세요">
    <button onclick="handleSearch()">검색</button>
</div>
<!-- 검색 결과 표시 영역 -->
<div id="search-results"></div>
<div id="map"></div>
<div id="location"></div>


<script>

    // 위치 정보를 가져오는 과정에서 오류가 발생했을 때 호출되는 함수
    function showError(error) {
        switch (error.code) {
            case error.PERMISSION_DENIED:
                document.getElementById('location').innerHTML = "사용자가 위치 정보를 허용하지 않았습니다.";
                break;
            case error.POSITION_UNAVAILABLE:
                document.getElementById('location').innerHTML = "위치 정보를 사용할 수 없습니다.";
                break;
            case error.TIMEOUT:
                document.getElementById('location').innerHTML = "요청 시간이 초과되었습니다.";
                break;
            case error.UNKNOWN_ERROR:
                document.getElementById('location').innerHTML = "알 수 없는 오류가 발생했습니다.";
                break;
        }
    }

      // 네이버 검색 API 호출하여 병원 정보 가져오기
      async function searchHospital(name) {
        try {
            const response = await fetch(`/api/search?query=${encodeURIComponent(name)}`);
            const data = await response.json();

            if (data.items && data.items.length > 0) {
                displaySearchResults(data.items);
            } else {
                document.getElementById('search-results').innerHTML = "검색 결과가 없습니다.";
            }
        } catch (error) {
            console.error("네이버 검색 API 요청 오류:", error);
            document.getElementById('search-results').innerHTML = "검색 중 오류가 발생했습니다.";
        }
    }

    // 검색 결과를 표시하는 함수
    function displaySearchResults(results) {
        const searchResultsDiv = document.getElementById("search-results");
        searchResultsDiv.innerHTML = ""; // 기존 결과 초기화

        results.forEach(result => {
            const resultDiv = document.createElement("div");
            resultDiv.innerHTML = `
                <div style="border: 1px solid #ccc; padding: 10px; margin-top: 10px;">
                    <h3>${result.title}</h3>
                    <p>주소: ${result.address}</p>
                    <p>카테고리: ${result.category}</p>
                    <p><a href="${result.link}" target="_blank">자세히 보기</a></p>
                </div>
            `;
            searchResultsDiv.appendChild(resultDiv);
        });
    }

    // 검색 버튼 클릭 시 호출되는 함수
    function handleSearch() {
        const searchInput = document.getElementById("search-input").value.trim();
        if (searchInput) {
            searchHospital(searchInput); // 입력된 병원 이름으로 검색 API 호출
        } else {
            alert("검색어를 입력해주세요.");
        }
    }

    // 현재 위치를 가져오는 함수
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            document.getElementById('location').innerHTML = "이 브라우저는 Geolocation을 지원하지 않습니다.";
        }
    }

    // 비동기로 서버에서 API 키를 가져와서 네이버 맵 API 스크립트를 동적으로 추가
    async function loadNaverMapScript() {
        try {
            const response = await fetch('/api/naver-map-key');
            const apiKey = await response.text();

            // 네이버 지도 API 스크립트 동적으로 로드
            const script = document.createElement('script');
            script.src = `https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=${apiKey}&submodules=geocoder`;
            document.head.appendChild(script);

            // 스크립트 로드 후 초기화 작업을 진행
            script.onload = function() {
                initMap(); // 지도 초기화 함수 호출
            };
        } catch (error) {
            console.error('API 키를 가져오는 중 오류 발생:', error);
        }
    }
        // 네이버 지도 로드 후 초기화 함수 호출
        function initMap() {
        // 현재 위치를 가져와 지도와 병원 표시
        getLocation();
        }

    // 좌표계 정의 (EPSG:2097 -> WGS84)
    const epsg2097 = '+proj=tmerc +lat_0=38 +lon_0=127.00289027777778 +k=1 +x_0=200000 +y_0=500000 +ellps=GRS80 +units=m +no_defs';
    const wgs84 = '+proj=longlat +datum=WGS84 +no_defs';

    // 현재 위치를 가져오는 함수
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            document.getElementById('location').innerHTML = "이 브라우저는 Geolocation을 지원하지 않습니다.";
        }
    }

    // 위치 정보를 가져오면 호출되는 함수
    function showPosition(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        document.getElementById('location').innerHTML = `위도: ${lat}, 경도: ${lon}`;

        // 네이버 지도 초기화
        const map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(lat, lon), // 현재 위치로 지도 중심 설정
            zoom: 15
        });

        // 현재 위치에 마커 추가
        const userMarker = new naver.maps.Marker({
            position: new naver.maps.LatLng(lat, lon),
            map: map,
            title: "내 위치",
            icon: {
                content: '<div style="background-color:red;width:20px;height:20px;border-radius:50%;"></div>',
                anchor: new naver.maps.Point(10, 10) // 아이콘의 기준점
            }
        });

        // 동물병원 데이터 API 호출 (서울 + 경기)
        fetchSeoulAnimalHospitals(map, lat, lon);
        fetchGyeonggiAnimalHospitals(map, lat, lon);
    }

    // 서울 동물병원 정보를 가져오는 함수 (XML 데이터 파싱)
    function fetchSeoulAnimalHospitals(map, lat, lon) {
        const apiUrl = 'http://openapi.seoul.go.kr:8088/554b61464f74706735315a42504b43/xml/LOCALDATA_020301/1/1000/';

        fetch(apiUrl)
            .then(response => response.text())
            .then(data => {
                const parser = new DOMParser();
                const xml = parser.parseFromString(data, "text/xml");
                const rows = xml.getElementsByTagName('row');
                const hospitals = [];

                for (let i = 0; i < rows.length; i++) {
                    const trdState = rows[i].getElementsByTagName('TRDSTATEGBN')[0]?.textContent;
                    if (trdState !== '03') continue; // 영업 중인 병원만

                    const name = rows[i].getElementsByTagName('BPLCNM')[0]?.textContent || "병원 이름 없음";
                    const address = rows[i].getElementsByTagName('RDNWHLADDR')[0]?.textContent || "주소 정보 없음";
                    const phone = rows[i].getElementsByTagName('SITETEL')[0]?.textContent || "전화번호 정보 없음";
                    const x = rows[i].getElementsByTagName('X')[0]?.textContent;
                    const y = rows[i].getElementsByTagName('Y')[0]?.textContent;

                    if (!x || !y) continue;

                    const [longitude, latitude] = proj4(epsg2097, wgs84, [parseFloat(x), parseFloat(y)]);
                    const distance = getDistance(lat, lon, latitude, longitude);

                    if (distance <= 5) { //5km이내의 병원만 표시
                        hospitals.push({ name, address, phone, latitude, longitude, distance });
                    }
                }
                displayHospitalsOnMap(map, hospitals);
            })
            .catch(error => console.error('서울 API 요청 오류:', error));
    }

    // 경기 동물병원 정보를 가져오는 함수 (XML 데이터 파싱)
    function fetchGyeonggiAnimalHospitals(map, lat, lon) {
        const apiUrl = 'https://openapi.gg.go.kr/Animalhosptl?KEY=72d8c20783d44c40a150cc75757bae44&pIndex=1&pSize=1000';

        fetch(apiUrl)
            .then(response => response.text())
            .then(data => {
                const parser = new DOMParser();
                const xml = parser.parseFromString(data, "text/xml");
                const rows = xml.getElementsByTagName('row');
                const hospitals = [];

                for (let i = 0; i < rows.length; i++) {
                    const bsnState = rows[i].getElementsByTagName('BSN_STATE_NM')[0]?.textContent;
                    if (bsnState !== '정상') continue;

                    const name = rows[i].getElementsByTagName('BIZPLC_NM')[0]?.textContent || "병원 이름 없음";
                    const address = rows[i].getElementsByTagName('REFINE_LOTNO_ADDR')[0]?.textContent || "주소 정보 없음";
                    const phone = rows[i].getElementsByTagName('LOCPLC_FACLT_TELNO')[0]?.textContent || "전화번호 정보 없음";
                    const longitude = parseFloat(rows[i].getElementsByTagName('REFINE_WGS84_LOGT')[0]?.textContent);
                    const latitude = parseFloat(rows[i].getElementsByTagName('REFINE_WGS84_LAT')[0]?.textContent);

                    const distance = getDistance(lat, lon, latitude, longitude);
                    if (distance <= 5) {
                        hospitals.push({ name, address, phone, latitude, longitude, distance });
                    }
                }
                displayHospitalsOnMap(map, hospitals);
            })
            .catch(error => console.error('경기 API 요청 오류:', error));
    }

    // 두 지점 간의 거리 계산 (Haversine formula)
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = deg2rad(lat2 - lat1);
        const dLon = deg2rad(lon2 - lon1);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // 각도를 라디안으로 변환
    function deg2rad(deg) { return deg * (Math.PI / 180); }

    // 병원을 지도에 표시하는 함수
    function displayHospitalsOnMap(map, hospitals) {
        hospitals.forEach(hospital => {
            const marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(hospital.latitude, hospital.longitude),
                map: map,
                title: hospital.name
            });

            const infoWindow = new naver.maps.InfoWindow({
                content: `<div style="padding:10px;"><strong>${hospital.name}</strong><br>주소: ${hospital.address}<br>전화번호: ${hospital.phone}<br>거리: ${hospital.distance.toFixed(2)} km</div>`
            });

            naver.maps.Event.addListener(marker, 'mouseover', () => infoWindow.open(map, marker));
            naver.maps.Event.addListener(marker, 'mouseout', () => infoWindow.close());
            naver.maps.Event.addListener(marker, 'click', () => window.open(`https://map.naver.com/p/search/${encodeURIComponent(hospital.address)}`, '_blank'));
        });
    }

    loadNaverMapScript(); // 스크립트 비동기 로드 시작

    

</script>

</body>
</html>
